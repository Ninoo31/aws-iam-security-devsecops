name: Checkov IaC Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  checkov-scan:
    name: Checkov Security Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Checkov
        run: |
          pip install checkov
          checkov --version

      - name: Run Checkov Scan
        run: | 
          checkov \
            --directory . \
            --framework terraform \
            --output cli \
            --output sarif \
            --output-file-path console,results/checkov-results.sarif \
            --skip-path tests/ \
            --check CRITICAL,HIGH,MEDIUM
            --hard-fail-on CRITICAL,HIGH
      
      - name: Upload Checkov SARIF to GitHub
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: results/checkov-results.sarif
      
      - name: Generate summary report
        if: always()
        run: |
          echo "## ðŸ” Checkov Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Severity Filter: CRITICAL, HIGH, MEDIUM only" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ExÃ©cute Checkov with severity filters
          checkov -d . \
            --framework terraform \
            --skip-path tests/ \
            --check CRITICAL,HIGH,MEDIUM \
            --compact \
            > checkov_output.txt || true
          
          # Extract statistiques
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          grep -A 20 "Passed checks:" checkov_output.txt >> $GITHUB_STEP_SUMMARY || echo "No summary available" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY